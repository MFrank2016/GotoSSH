#!/bin/bash

# GOTO SSH - Auto Login SSH Server
#
# @author   MFrank2016
# @link     https://github.com/MFrank2016/GotoSSH
#
# Usage:
# $ chmod a+x gotossh
# $ sudo cp gotossh /usr/local/bin/
# $ 'test_server||192.168.0.1||root||password||22||0||test-service'  > ~/.gotossh_config
# $ gotossh   // List Server
# $ gotossh 1 // Login Num n Server



VERSION=3.1
TMP_FILE="$HOME/.gotossh_tmpfile"
BARGE_FILE=$(pwd)"/barge.yaml"
# è‹¥ä¸´æ—¶è„šæœ¬æ–‡ä»¶ä¸å­˜åœ¨åˆ™åˆ›å»º
if [ ! -f ${TMP_FILE} ]; then
	touch ${TMP_FILE}
fi
echo "" > ${TMP_FILE}
CONFIG_FILE="$HOME/.gotossh_config"
GOTO_SSH_CONFIG=""
LINE_BEGIN="\033[1;32m"
LINE_END="\033[0m"
BORDER_LINE="${LINE_BEGIN}############################################################################# ${LINE_END}"
MAX_LINE_LENGTH=$(expr "${#BORDER_LINE}")
I=0;
COMMAND_LIST=""
COMMAND_NUM=0





# ==============å®šä¹‰è¾“å‡ºå‡½æ•°============
# è¾“å‡º-ã€é¦–/å°¾è¡Œã€‘
echoFullLine(){
    echo -e  ${BORDER_LINE}
}

# è¾“å‡º-ã€é—´éš”è¡Œã€‘
echoSkipLine(){
    echo -e  "${LINE_BEGIN}#                                                                           # ${LINE_END}"
}

# è¾“å‡º-ã€æ­£ä¸­æç¤ºä¿¡æ¯ã€‘
echoMiddleLine(){
	local lineBegin="${LINE_BEGIN}#"
	local lineEnd="# ${LINE_END}"
	local info=${1}
	local length=$(expr "${#info}")
	local num=$(expr ${MAX_LINE_LENGTH} - ${#info} - 20)
	num=$((num/2))
	echo -e  $lineBegin"\c"
    for n in $(seq ${num});
    do
        echo -e  " \c"
    done
    echo -e ${info}" \c"
    # ä¿®å¤issue 1
    local tmpNum=$(expr ${MAX_LINE_LENGTH} - ${num} - ${#info} - 20 - 1)
    for n in $(seq ${tmpNum});
    do
        echo -e  " \c"
    done
    echo -e  "# ${LINE_END}"
}

# è¾“å‡º-ã€é å·¦è¾“å‡ºä¸€è¡Œã€‘
echoLeftLine(){
    local tmpLine="${LINE_BEGIN}#"\ [${1}]\ ${2}
    local currentLineLength=$(expr "${#tmpLine}")
    local disLineLength=$(expr ${MAX_LINE_LENGTH} - ${currentLineLength} - 9)
    echo -e  $tmpLine"\c"
    for n in $(seq ${disLineLength});
    do
        echo -e  " \c"
    done
    echo -e  "# ${LINE_END}"
}

# è¾“å‡º-ã€æœåŠ¡å™¨ä¿¡æ¯è¡Œã€‘
echoServerLine(){
    local linkName=$(echo ${2} | sed 's/||/ /g' | awk '{ print $1 }')
    echoLeftLine ${1} ${linkName} 
    # local line="${LINE_BEGIN}#"\ [$I]\ ${linkName}
    # local currentLineLength=$(expr "${#line}")
    # local disLineLength=$(expr ${MAX_LINE_LENGTH} - ${currentLineLength} - 9)
    # echo -e  $line"\c"
    # for n in $(seq ${disLineLength});
    # do
    #     echo -e  " \c"
    # done
    # echo -e  "# ${LINE_END}"
}

# è¾“å‡º-ã€æç¤ºä¿¡æ¯ã€‘
echoTipsInfo(){
	echoFullLine
	echoMiddleLine "[GOTO SSH]"
	echoSkipLine
	echoMiddleLine "${1}"
	echoSkipLine
	echoSkipLine
	echoFullLine
}

# å‡½æ•°-ã€è¾“å‡ºå‘½ä»¤åˆ—è¡¨ã€‘
echoCommandList(){
	echoFullLine
	echoMiddleLine "[COMMAND LIST]"
	echoSkipLine
	local echoCommandList=$(sed -n '/\['${1}'\]/,/^\[/p'  ${CONFIG_FILE} | sed '/^\[.*\]/d' | awk -F '=' '{print $1}' | sed '/^$/d')
    echoCommandList=$(echo -e "no-subsequent-operation\n${echoCommandList}\n$(sed -n '/\[common-command\]/,/^\[/p'  ${CONFIG_FILE} | sed '/^\[.*\]/d' | awk -F '=' '{print $1}' | sed '/^$/d')" | sed '/^$/d')
    COMMAND_LIST=${echoCommandList}
    COMMAND_NUM=0
	local tmpNum=1
	for tmp in ${echoCommandList}; do
		echoLeftLine ${tmpNum} ${tmp}
		((tmpNum++))
	done
    COMMAND_NUM=${tmpNum}
	echoSkipLine
	echoSkipLine
	echoFullLine
}

# è¾“å‡º-ã€é…ç½®æ–‡ä»¶ä¸å­˜åœ¨ã€‘
echoConfigFileNotExist(){
	echoFullLine
	echoMiddleLine "[GOTO SSH]"
	echoSkipLine
	echoMiddleLine "Config(~/.gotossh_config) Not Found"
	echoSkipLine
	echoSkipLine
	echoFullLine
}

# è¾“å‡º-ã€é€‰æ‹©åˆ—è¡¨ã€‘
echoServerList(){
	echoFullLine
	echoMiddleLine "[GOTO SSH]"
	echoSkipLine
	echoSkipLine

	# å¾ªçŽ¯è¯»å–æœåŠ¡å™¨åç§°
	for serverLine in ${GOTO_SSH_CONFIG}; do
		((I++))
		if [[ "${serverLine}" == *\[Server* ]]; then
			break;
		fi
		echoServerLine ${I} ${serverLine}
	done

	echoSkipLine
	echoFullLine
}
# ===========è¾“å‡ºå‡½æ•°å®šä¹‰ç»“æŸ===========













# ==============é…ç½®æ–‡ä»¶å‡çº§å‡½æ•°===========

# å‡½æ•°-ã€å°†é…ç½®æ–‡ä»¶ä»Žv1ã€v2 å‡çº§åˆ°v3ã€‘
updateConfigV1V2toV3(){
	# ç¡®è®¤æ˜¯å¦å­˜åœ¨ç±»ä¼¼xxx||xxx||xxx||xxx||xxx||xxxé…ç½®
	local tmpS=$(grep ".*||.*||.*||.*||.*||.*" ${CONFIG_FILE})
	if [ -n "${tmpS}" ]; then
		return -1
	fi
	# å°†æœåŠ¡å™¨ä¿¡æ¯çš„åˆ†éš”ç¬¦ä»Ž|å˜ä¸º||
	sed -i '/|/,/\[/s/|/||/g' ${CONFIG_FILE}
	# å°†[ServerN]æ›¿æ¢ä¸º[Server-LinkName]
	local tmpCommand=$(grep -Eo '\[Server[0-9]+\]' ${CONFIG_FILE} | head -1)
	until [ -z "${tmpCommand}" ]
    do
    	local tmpNum=$(echo ${tmpCommand} | sed -r 's/\[Server([0-9]+)\]/\1/g')
        local tmpLinkName=$(sed -n "${tmpNum}p" ${CONFIG_FILE} | sed "s/||/ /g" | awk '{ print $1 }')
        if [ -z "${tmpLinkName}" ]; then
        	echo "The config of Server${tmpNum} doesn't exist!"
        	exit
        fi
        sed -i "s/Server${tmpNum}/Server-${tmpLinkName}/g" ${CONFIG_FILE}
        tmpCommand=$(grep -Eo '\[Server[0-9]+\]' ${CONFIG_FILE} | head -1)
    done
    sed -i '$a\\n[settings]\nversion='${VERSION} ${CONFIG_FILE}
}

# ==============é…ç½®æ–‡ä»¶å‡çº§ç»“æŸ===========










# ==============åˆ¤æ–­å½“å‰é…ç½®æ–‡ä»¶ç‰ˆæœ¬=====
if [ ! -f ${CONFIG_FILE} ]; then
	echoConfigFileNotExist
	exit
fi
GOTO_SSH_CONFIG="$(cat ~/.gotossh_config)"

SETTINGS=$(cat ${CONFIG_FILE} | sed -n '/\[settings\]/,/^\[/p')

if [ -z "${SETTINGS}" ]; then
	# v3ä¹‹å‰çš„ç‰ˆæœ¬æ²¡æœ‰æ”¹é€‰é¡¹ï¼Œéœ€å°†é…ç½®æ–‡ä»¶æ›´æ–°è‡³å½“å‰ç‰ˆæœ¬
	updateConfigV1V2toV3
fi
# ==============é…ç½®æ–‡ä»¶å¤„ç†ç»“æŸ========












# ==============è¾…åŠ©å‡½æ•°==============
# å‡½æ•°-ã€è¯»å–å‘½ä»¤ä¿¡æ¯ã€‘
readCommand(){
    local tmp_section="Server-"$1
    local tmp_command=$2
    local tmp_commandInfo=$(readINIInfo ${tmp_section} ${tmp_command})
    if [ -z "${tmp_commandInfo}" ]; then
        # å¦‚æžœè‡ªå®šä¹‰å‘½ä»¤ä¸­æœªè¯»å–åˆ°è¯¥å‘½ä»¤ï¼Œåˆ™å‰å¾€æ¨¡æ¿å‘½ä»¤ä¸­è¯»å–
        tmp_commandInfo=$(readINIInfo "common-command" ${tmp_command})
    fi
    echo "${tmp_commandInfo}"
}

# å‡½æ•°-ã€è¯»å–é…ç½®é¡¹ä¿¡æ¯ã€‘
readINIInfo(){
    local tmp_section=$1
    local tmp_key=$2
    local tmp_iniInfo=$(sed -n "/\[${tmp_section}\]/,/^\[/p" ${CONFIG_FILE} | grep "^${tmp_key}=" | sed "s#${tmp_key}=##")
    echo "$tmp_iniInfo"
}

# å‡½æ•°-ã€æ›¿æ¢å‘½ä»¤ä¸­çš„å‚æ•°ã€‘
replaceCommandAttribute(){
    local tmp_section="Server-Attribute-${1}"
    local tmp_command=${2}
    # å…ˆæ›¿æ¢[P1][P2]
    tmp_command=$(echo "${tmp_command}" | sed -e "s|\[P1\]|${3}|;s|\[P2\]|${4}|")
    # æ›¿æ¢è‡ªå®šä¹‰å±žæ€§
    while [[ "${tmp_command}" == *\[*\]* ]]
    do
        local tmp_key=$(echo ${tmp_command} | sed -r 's/.*\[(.*)\].*/\1/')
        local tmp_attribute=$(readINIInfo ${tmp_section} ${tmp_key})
        if [ -z "${tmp_attribute}" ]; then
            echo "Attribute Not Found:${tmp_key}!"
            exit
        fi
        tmp_command=$(echo ${tmp_command} | sed "s/\[${tmp_key}\]/${tmp_attribute}/")
    done  
    echo ${tmp_command}
}

# å‡½æ•°-ã€å‘ä¸´æ—¶è„šæœ¬ä¸­æ’å…¥æœåŠ¡å™¨ç™»å½•ä¿¡æ¯ã€‘
insertServerInfo(){
    local tmpIp=$(echo ${1} | sed 's/||/ /g' | awk '{ print $2 }')
    local tmpName=$(echo ${1} | sed 's/||/ /g' | awk '{ print $3 }')
    local tmpPwd=$(echo ${1} | sed 's/||/ /g' |  awk '{ print $4 }')
    local tmpPort=$(echo ${1} | sed 's/||/ /g' |  awk '{ print $5 }')
    local tmpRely=$(echo ${1} | sed 's/||/ /g' |  awk '{ print $6 }')
    echo "spawn ssh -p${tmpPort} -l "$tmpName $tmpIp >> ${TMP_FILE}
    if [ -n "${tmpPwd}"  ]; then
		echo 'expect {
		"*yes/no" { send "yes\r"; exp_continue }
		"*password*" { send "'${tmpPwd}'\r" }
		}' >> ${TMP_FILE}
        echo 'expect "*:~*"' >> ${TMP_FILE}
    fi
}

# å‡½æ•°-ã€å‘ä¸´æ—¶è„šæœ¬ä¸­æ’å…¥scpå‘½ä»¤ä¿¡æ¯ã€‘
insertSCPInfo(){
    local tmpIp=$(echo ${1} | sed 's/||/ /g' | awk  '{ print $2 }')
    local tmpName=$(echo ${1} | sed 's/||/ /g' | awk  '{ print $3 }')
    local tmpPwd=$(echo ${1} | sed 's/||/ /g' | awk  '{ print $4 }')
    local tmpPort=$(echo ${1} | sed 's/||/ /g' | awk  '{ print $5 }')
    local tmpRely=$(echo ${1} | sed 's/||/ /g' | awk  '{ print $6 }')
    if [ "${4}" != "" ]; then
        echo "spawn scp ${tmpName}@${tmpIp}:${2} ${3}" >> ${TMP_FILE}
    else
        echo "send \"scp ${tmpName}@${tmpIp}:${2} ${3}\r\"" >> ${TMP_FILE}
    fi
    echo 'expect "*password:"' >> ${TMP_FILE}
    echo 'send  "'${tmpPwd}'\r"' >> ${TMP_FILE}
    echo 'expect "*:~*"' >> ${TMP_FILE}
}

# å‡½æ•° -ã€ç”Ÿæˆbargeæ–‡ä»¶ã€‘
generateBargeFile(){
    # è‹¥æ–‡ä»¶ä¸å­˜åœ¨åˆ™åˆ›å»º
    if [ ! -f ${BARGE_FILE} ]; then
        touch ${BARGE_FILE}
    fi
    echo "apiVersion: 0.0.4" > ${BARGE_FILE}
    echo "apps:" >> ${BARGE_FILE}
    echo "  - appName: "${1}  >> ${BARGE_FILE}
    echo "    build:" >> ${BARGE_FILE}
    echo "      language: java" >> ${BARGE_FILE}
    echo "      maven:" >> ${BARGE_FILE}
    echo "        pom: pom.xml" >> ${BARGE_FILE}
    echo "        skipTests: true" >> ${BARGE_FILE}
    echo "        profile: test" >> ${BARGE_FILE}
    echo "        jar: test" >> ${BARGE_FILE}
    echo "        mainClass: test" >> ${BARGE_FILE}
    echo "    deploy:" >> ${BARGE_FILE}
    echo "      isolation: stable" >> ${BARGE_FILE}
    echo "      expire: 1h" >> ${BARGE_FILE}
}

# å‡½æ•° -ã€èŽ·å–barge IP ä¿¡æ¯ã€‘
getBargeSSHInfo(){
    BARGE_IP=$(barge info | sed -n '$p')
    BARGE_IP=${BARGE_IP#*@}
    BARGE_IP=${BARGE_IP%[0m}
}

# å‡½æ•° -ã€æœåŠ¡å™¨æ˜¯å¦é…ç½®äº†è¯¥å‘½ä»¤ä¸­çš„å±žæ€§ã€‘
ifCommandConfiged(){
    
}
# ===================================















# ==============å¼€å§‹å¤„ç†å‘½ä»¤å‚æ•°===========
# -l å‘½ä»¤
if [ "${1}" == "-l" ]; then
	echoServerList
	exit
fi

# è¯»å–é€‰æ‹©çš„æœåŠ¡å™¨
if [ -n "${1}" ]; then
    NO=${1}
else
    NO=0
    echoServerList
    until [ ${NO} -gt 0 -a ${NO} -le ${I} ] 2>/dev/null
    do
        echo -e  'Server Number:\c'
        read NO
    done
fi


# è¯»å–è¯¥æœåŠ¡å™¨é…ç½®
SERVER_INFO=$(sed -n "${NO}p" ${CONFIG_FILE})
if [ -z "${SERVER_INFO}" ]; then
	echoTipsInfo "Server Info Not Found!"
	exit
fi

LINK_NAME=$(echo ${SERVER_INFO} | sed 's/||/ /g' | awk  '{ print $1 }')
IP=$(echo ${SERVER_INFO} | sed 's/||/ /g' | awk  '{ print $2 }')
NAME=$(echo ${SERVER_INFO} | sed 's/||/ /g' | awk  '{ print $3 }')
PWD=$(echo ${SERVER_INFO} | sed 's/||/ /g' | awk  '{ print $4 }')
PORT=$(echo ${SERVER_INFO} | sed 's/||/ /g' | awk  '{ print $5 }')
RELY=$(echo ${SERVER_INFO} | sed 's/||/ /g' | awk  '{ print $6 }')
SERVICE_NAME=$(echo ${SERVER_INFO} | sed 's/||/ /g' | awk  '{ print $7 }')
SERVER_CONFIG_NAME="Server-"${LINK_NAME}

# -cl å‘½ä»¤-è¾“å‡ºè¯¥æœåŠ¡å™¨çš„è‡ªå®šä¹‰å‘½ä»¤åˆ—è¡¨
if [ "${2}" == "-cl" ]; then
	echoCommandList ${SERVER_CONFIG_NAME}
	exit
fi

echo '#!/usr/bin/expect -f' > ${TMP_FILE}
echo 'set timeout 30' >> ${TMP_FILE}

# scpå‘½ä»¤
if [ "${2}" == "scp" -a "${3}" != "" ]; then
    logPath=$(readINIInfo "scp" "${3}")
    if [ -z "${logPath}" ]; then
    	logPath=${3}
    fi
    if [ "${RELY}" == "0" ]; then
        insertSCPInfo ${SERVER_INFO} ${logPath} "./${logPath##*/}" "0"
    else
        relyServer=`cat ~/.gotossh_config | sed -n  ${RELY}'P'`
        insertServerInfo ${relyServer}
        # time=`date '+%Y%m%d_%H%M%S'`
        oldPath=${logPath}
        # fileName=${logPath##*/}"-"${time}
        fileName=${logPath##*/}
        insertSCPInfo ${SERVER_INFO} ${oldPath} "~/${fileName}"
        echo "send \"exit\r\"" >> ${TMP_FILE}
        echo 'expect "*:~*"' >> ${TMP_FILE}
        insertSCPInfo ${relyServer} "./"${fileName} "./"${fileName} "0"
    fi
    chmod a+x ${TMP_FILE}
    ${TMP_FILE}
    echo '' > ${TMP_FILE}
    exit
fi

if [ "${RELY}" != "0" ]; then
    relyServer=`cat ~/.gotossh_config | sed -n  ${RELY}'P'`
    insertServerInfo ${relyServer}
    echo "send \"ssh -p${PORT} -l ${NAME} ${IP}\r\"" >> ${TMP_FILE}
else
    if [[ ${IP} == barge-* ]]; then
        IP=${IP#*-}
        generateBargeFile "${IP}"
        getBargeSSHInfo
        if [ ${#BARGE_IP} -gt 15 ]; then
            echo ${BARGE_IP}
            exit
        fi
        IP=${BARGE_IP}
    fi
    echo "spawn ssh -p${PORT} -l "${NAME} ${IP} >> ${TMP_FILE}
fi

if [ -z "${PORT}"  ]; then
    PORT=22
fi

# è¯»å–å‘½ä»¤å‚æ•°
if [ -n "${2}" ]; then
    COMMAND=$(readCommand ${LINK_NAME} ${2})
else
    # è¾“å‡ºå‘½ä»¤åˆ—è¡¨
	tmpA=$(grep "\[${SERVER_CONFIG_NAME}\]" ${CONFIG_FILE} | wc -l)
	tmpB=$(grep "\[common-command\]" ${CONFIG_FILE} | wc -l)
	if [ "${tmpA}" -gt "0" -o "${tmpB}" -gt "0" ]; then
		echoCommandList ${SERVER_CONFIG_NAME}
		COMMAND_NUMBER=0
		until [ ${COMMAND_NUMBER} -gt 0 -a ${COMMAND_NUMBER} -le ${COMMAND_NUM} ] 2>/dev/null
	    do
	        echo -e  'Command Number:\c'
	        read COMMAND_NUMBER
	    done
		if [ ${COMMAND_NUMBER} -eq "1" ]; then
			COMMAND=""
		else
			COMMAND=$(echo "${COMMAND_LIST}" | sed -n "${COMMAND_NUMBER}p")
        	COMMAND=$(readCommand ${LINK_NAME} ${COMMAND})
	    fi
	fi
fi


if [ -n "${COMMAND}" ]; then
    COMMAND=$(replaceCommandAttribute "${LINK_NAME}" "${COMMAND}" "${3}" "${4}")
fi
# exit

# å¤„ç†å‘½ä»¤ä¸­çš„å¯†ç 
if [[ ${COMMAND} == *\|* ]]; then
    COMMAND_PWD=$(echo ${COMMAND} | awk -F\| '{ print $2 }')
    COMMAND="${COMMAND%%|*}"
fi


if [ -n "${PWD}"  ]; then
	echo 'expect {
		"*yes/no" { send "yes\r"; exp_continue }
		"*password*" { send "'${PWD}'\r" }
		}' >> ${TMP_FILE}
    echo 'expect "*:~*"' >> ${TMP_FILE}
    if [ -n "${COMMAND}" ]; then
        echo 'send  "'${COMMAND}'\r"' >> ${TMP_FILE}
    fi
    if [ -n "${COMMAND_PWD}" ]; then
        echo 'expect "*password:"' >> ${TMP_FILE}
        echo 'send  "'${COMMAND_PWD}'\r"' >> ${TMP_FILE}
    fi
fi

echo 'interact' >> ${TMP_FILE}
chmod a+x ${TMP_FILE}
${TMP_FILE}
echo '' > ${TMP_FILE}
# ======================================
